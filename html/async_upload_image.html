<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
	<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
	<title>async upload_image ( page, target_file, content )</title>
	<style type="text/css">
		@page { size: 11in 17in; margin-left: 0.5in; margin-right: 0.44in; margin-top: 0.79in; margin-bottom: 0.79in }
		p { margin-bottom: 0.1in; line-height: 115%; background: transparent }
		h3 { margin-top: 0.1in; margin-bottom: 0.08in; background: transparent; page-break-after: avoid }
		h3.western { font-family: "Liberation Sans", sans-serif; font-size: 14pt; font-weight: bold }
		h3.cjk { font-family: "Noto Sans CJK SC"; font-size: 14pt; font-weight: bold }
		h3.ctl { font-family: "FreeSans"; font-size: 14pt; font-weight: bold }
	</style>
</head>
<body lang="en-US" link="#000080" vlink="#800000" dir="ltr">
<h3 class="western" style="page-break-before: always">async upload_image ( page, target_file, content )</h3>
<h4>Flowchart</h4>
<figure style="align:center;">
  <img 
    src="image/async_upload_image.png" 
    name="async_upload_image" 
    alt="async upload_image ( page, target_file, content )" 
    width="1093" 
    height="5409" 
    usemap="#map"
    border="1"
    style="display:block; margin: 0 auto 0 auto;"
  />
</figure>
<map name="map">
  <a title="async upload_image ( page, target_file, content )">
    <area shape="rect" coords="138,153,495,196" alt="async upload_image ( page, target_file, content )" href="async_goto_img_uploader_page.html" />
  </a>
  <a title="async check_node_availability ( page, node_identity )">
    <area shape="rect" coords="1,232,631,274" alt="async check_node_availability ( page, node_identity )" href="async_check_node_availability.html" />
  </a>
</map>

<h4>Code</h4>
<pre>
  async upload_image ( page, target_file, content ){
    
    var id_image = null;

    await this.goto_img_uploader_page( page );
      
    let img_title_node = await this.check_node_availability( page, "#img_title"   );

    echo( "img_title_node: ", !!img_title_node );
            
    if( !img_title_node ){
      
      echo( "img_title_node not found" );
        
      return;
        
    }
    
    let input_file_node = await this.check_node_availability( page, 'input[type="file"]' );
      
    echo( "input_file_node: ", !!input_file_node );
      
    if( !img_title_node ){
      
      echo( "input_file_node not found" );
        
      return;
        
    }
        
    const imgHandler = await page.$( 'input[type="file"]' );
    
    echo( "uploading image file" );
          
    let ret_uploading = await imgHandler.uploadFile( target_file )
      .then( 
        (resolved)=>{
          return true;
        },
        (rejected)=>{
          return false;
        }
      )
      .catch( (err) => {
        return false;
    })
        
    echo( "uploading returned : ", ret_uploading );
          
    await page.waitForTimeout( 10000 );
        
    await page.waitForSelector( "#id_image", { timeout:20000 } );   
    
    do{
      
      id_image = await page.$eval( "#id_image", el => el.value );
        
    } while( !id_image );
    
    echo( "id_image: ", id_image );
      
    // check if file exists
    echo( "checking if file id_image exists" );
      
    var ret_fs_stat = await _FS.stat("id_image", async ( err, stat )=>{ return ( !err ) ? true : false; } );
      
    if( !!ret_fs_stat ){
      echo( "target file exists" );
        
      echo( "clear file id_image" );
      let is_empty = await _FS.truncate( "id_image", 0, async ( err, bytes )=>{
        return (( !err ) ? true : false);
      } );
        
      echo( "if clearing file failed, stop." );
      if( !is_empty ){
        echo( "emptying file failed" );
        return;
      }
        
      echo( "store id_image to file" );
      let store_id_image = await _FS.writeFile( "id_image", id_image, async ( err )=>{
          return (( !err ) ? 1 : 0 );
      } );
      echo( "store_id_image: ", store_id_image );
        
    } else if( !ret_fs_stat ){
      echo( "target file does not exist" );
      echo( "create file id_image and save data" );
      let save_id_image = await _FS.writeFile( "id_image", id_image, ( err )=>{
        return (( !err ) ? 1 : 0);
      } );
      echo( "save_id_image to file: ", save_id_image );
    }
      
    echo( "\nSET IMAGE TITLE\n" );
      
    echo( "focus on element #img_title" );
    await page.focus( "#img_title" );
      
    echo( "empty value of input element #img_title" );
    await page.evaluate( ()=>{ document.querySelector( "#img_title" ).value="" } );
      
    echo( "type image title" );
    await page.keyboard.type( content );
      
    echo( "\nSET IMAGE DESCRIPTION\n" );
      
    echo( "focus on element #img_description" );
    await page.focus( "#img_description" );
      
    echo( "empty value of element #img_description" );
    await page.evaluate( ( )=>{ document.querySelector( "#img_description" ).value="" } );
      
    echo( "type content" );
    await page.keyboard.type( content );
      
    echo( "\nSET IMAGE ALTERNATE\n" );
      
    echo( "focus on element #img_alt" );
    await page.focus( "#img_alt" );
      
    echo( "empty value of element #img_alt" );
    await page.evaluate( ( )=>{ document.querySelector( "#img_alt" ).value="" } );
      
    echo( "type image alternate" );
    await page.keyboard.type( content );
      
    echo( "click button #btn_img_attr to save image data" );
    await page.click( "#btn_img_attr" );
      
    let response = await page.waitForResponse( async ( response ) => { return response } );
     
    if( response.status() == 200 && response.url().includes( 'https://palmerah.implantgigi.com/insight/image/index/' )  ){
      echo( "uploading success" );
      echo( "finish uploading image" );
    }

    return id_image;

  }
</pre>

<h4>Refers to:</h4>
<ol>
	<li><p style="margin-bottom: 0in; line-height: 100%"><a href="async_goto_img_uploader_page.html" title="async goto_img_uploader_page( page )">async goto_img_uploader_page( page )</a></p></li>
	<li><p style="margin-bottom: 0in; line-height: 100%"><a href="async_check_node_availability.html" title="async check_node_availability ( page, node_identity )">async check_node_availability ( page, node_identity )</a></p></li>
</ol>
</body>
</html>
